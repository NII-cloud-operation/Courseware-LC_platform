#!/bin/bash

reportfailed()
{
    echo "Script failed...exiting. ($*)" 1>&2
    exit 255
}

imageid="$1"
hostpath="$2"
containerpath="$3"

: ${containerpath:="/home/jovyan/work"}

usage()
{
    cat <<EOF

Usage:
  ${0##*/} <image_id> <host_dir_path> <container_dir_path>
EOF
    exit 1
}

[ "$#" -eq 2 ] || [ "$#" -eq 3 ] || usage

# -v seems to require full absolute path
abshostpath="$(cd "$hostpath" && pwd -P)" || {
    echo "Directory '$hostpath' does not exist"
    usage
}

docker inspect --type image "$imageid" 1>/dev/null 2>&1 || {
    echo "Image '$imageid' is not a valid image id"
    usage
}

contid="$(docker run -d -it -p 8000-8500:8888 -v "$abshostpath:$containerpath" "$imageid")"
rc1="$?"

port="$(docker inspect --type container \
        --format='{{(index (index .NetworkSettings.Ports "8888/tcp") 0).HostPort}}' \
        "$contid")"
rc2="$?"

# Upload scripts (mainly jupyter_runner) to container
tar c -C /home/centos bin | docker exec -i "$contid" tar x -C /home/jovyan
docker exec "$contid" bash -c "echo 'PATH=~/bin:\$PATH' >>~/.bashrc"

{
    [ "$rc1" != "0" ] && echo "Warning: docker run command return code was $rc1"
    [ "$rc2" != "0" ] && echo "Warning: docker inspect command return code was $rc2"
} 1>&2

echo "ID=${contid:0:12}   PORT=$port"
