#!/bin/bash


reportfailed()
{
    echo "Script failed...exiting. ($*)" 1>&2
    exit 255
}

usage()
{
    cat <<EOF
Usage:

./bin/coursectl list              ## Lists assigned JupyterHub servers
./bin/coursectl new {hub_dir} {admin_mail_address}       ## Assigns new JupyterHub server
./bin/coursectl delete {hub_dir}    ## Disconnects JupyterHub server
./bin/coursectl restart {hub_dir}   ## Restarts JupyterHub server

EOF
}

export ORGCODEDIR="$(cd "$(dirname $(readlink -f "$0"))" && pwd -P)" || reportfailed

rootdir="${ORGCODEDIR%/*}"

AUTH_PROXY_NAME=root_nginx_3

JUPYTER_USER_ID=1001

SSH_IDP_PROXY_KEY=~/.ssh/ssh-idp-proxy    

function init_jupyterhub()
{
    local hubdir="$1"  # Path to the build directory
    local teacher_mail="$2"

    [ -d "$hubdir" ] || reportfailed "Hub directory '$hubdir' does not exist."
    [ -z "$teacher_mail" ] && reportfailed "Administrator's email address does not specfied."

    echo "hubdir: "$hubdir
    echo "teacher_mail: "$teacher_mail

    # remove original proxy container
    "$hubdir"/jhvmdir-hub/ssh-shortcut.sh -q sudo docker rm -f root_nginx_1

    # create local user id of teacher from teacher's mail address
    teacherid=$("$hubdir"/jhvmdir-hub/ssh-shortcut.sh -q sudo docker exec -i ${AUTH_PROXY_NAME} bash << EOF
php -r "require_once '/var/www/php/functions.php'; echo get_username_from_mail_address('"$teacher_mail"');"
EOF
)
    echo "teacherid: "$teacherid 

    # generate ssh keys for local user operetion from teacher's Jupyter server
    hub_ssh_key='ssh-hub'
    ssh-keygen -t rsa -b 2048 -N "" -f /tmp/$hub_ssh_key

    # configure jupyterhub 
    reconfigure_one_jupyterhub "$hubdir" "$teacherid"
    push_hub_patch "$hubdir" 1>/dev/null
    create_directory_structure "$hubdir" "$teacherid"
    
    # set ssh key for auth-proxy
    (cd /tmp; tar c $hub_ssh_key) | \
	"$hubdir/jhvmdir-hub/ssh-shortcut.sh" -q sudo tar xv -C /jupyter/admin/$teacherid/.ssh/
    rm /tmp/$hub_ssh_key
    # add ssh public key to authorized_keys
    cat "/tmp/${hub_ssh_key}.pub" | \
        "$hubdir"/jhvmdir-hub/ssh-shortcut.sh -q "sudo cat - >> /home/ubuntu/.ssh/authorized_keys"
    rm /tmp/${hub_ssh_key}.pub
    "$hubdir"/jhvmdir-hub/ssh-shortcut.sh -q "sudo chown -R '$JUPYTER_USER_ID:$JUPYTER_USER_ID' '/jupyter/admin/$teacherid/.ssh'"

    echo "Restarting new JupyterHub container."
    "$hubdir"/jhvmdir-hub/ssh-shortcut.sh -q sudo docker stop root_jupyterhub_1
    "$hubdir"/jhvmdir-hub/ssh-shortcut.sh -q sudo docker start root_jupyterhub_1
    
    echo "Configuring auth-proxy container."
    hubip="$(source "$hubdir/jhvmdir-hub/datadir.conf" ; echo "$VMIP")"
    dbip=$("$hubdir"/jhvmdir-hub/ssh-shortcut.sh -q sudo docker inspect --format='{{.NetworkSettings.IPAddress}}' root_jpydb_1)
    hubport=8000
    # configure hub-const.php
    "$hubdir"/jhvmdir-hub/ssh-shortcut.sh -q << EOF
sed -i "s,HUB_URL = .*,HUB_URL = \"http://$hubip:$hubport\";," /home/ubuntu/auth-proxy/php/hub-const.php
sed -i "s,DB_HOST = .*,DB_HOST = \"$dbip\";," /home/ubuntu/auth-proxy/php/hub-const.php
EOF
    # configure nginx.conf
    "$hubdir"/jhvmdir-hub/ssh-shortcut.sh -q sudo docker exec -i ${AUTH_PROXY_NAME} bash << EOF
sed -i "s,proxy_pass http:.*,proxy_pass http://$hubip:$hubport;," /etc/nginx/nginx.conf
EOF
    # configure .hub-config in the admin container
    echo "Configuring .hub-config."
    node_list="$(source "$hubdir/datadir.conf"; echo "$node_list")"
    array=""
    for node in $node_list; do
        ip=$(source "$hubdir/jhvmdir-${node}/datadir.conf"; echo "$VMIP")
        item="\"$node $ip"\"
        array+=$item" "
    done
    hub_config_name='.hub-config' 
    "$hubdir"/jhvmdir-hub/ssh-shortcut.sh -q << EOF
echo "HUB_IP=$hubip" > /jupyter/admin/$teacherid/$hub_config_name
echo "AUTH_PROXY_IP=$hubip" > /jupyter/admin/$teacherid/$hub_config_name
echo "AUTH_PROXY_NAME=${AUTH_PROXY_NAME}" >> /jupyter/admin/$teacherid/$hub_config_name
echo 'NODES=(' >> /jupyter/admin/$teacherid/$hub_config_name
echo '$array' >> /jupyter/admin/$teacherid/$hub_config_name
echo ')' >> /jupyter/admin/$teacherid/$hub_config_name
sudo chown "$JUPYTER_USER_ID:$JUPYTER_USER_ID" "/jupyter/admin/$teacherid/$hub_config_name"
EOF

    echo "Restarting auth-proxy nginx container."
    "$hubdir"/jhvmdir-hub/ssh-shortcut.sh -q sudo docker stop ${AUTH_PROXY_NAME}
    "$hubdir"/jhvmdir-hub/ssh-shortcut.sh -q sudo docker start ${AUTH_PROXY_NAME}

    echo "Restarting auth-proxy daemons."
    "$hubdir/jhvmdir-hub/ssh-shortcut.sh" -q << EOF
sudo docker exec -i ${AUTH_PROXY_NAME} bash << EOF2
(
  /etc/init.d/nginx start
  /etc/init.d/php5.6-fpm start
) >/tmp/dstart.log 2>&1
# The redirection is necessary otherwise init.d/nginx makes "docker exec" hang
EOF2
EOF

    # Add database schema of local user
    "$hubdir"/jhvmdir-hub/ssh-shortcut.sh -q \
    sudo docker exec -i root_jpydb_1 \
    /usr/lib/postgresql/9.6/bin/psql -U postgres -d jupyterhub << EOF
CREATE SEQUENCE local_users_id_seq START 1;
CREATE TABLE local_users (
    id  integer CONSTRAINT firstkey PRIMARY KEY,
    user_name  varchar(64) UNIQUE NOT NULL,
    password  varchar(128) NOT NULL,
    mail  varchar(64) NOT NULL
);
EOF

    # create password for teacher    
    password=$($rootdir/bin/pwgen.sh)

    # register teacher's userid and password
    "$hubdir"/jhvmdir-hub/ssh-shortcut.sh -q sudo docker exec -i ${AUTH_PROXY_NAME} bash << EOF
php -r "require_once '/var/www/php/db.php'; add_local_user('$teacher_mail', '$password');"
EOF

    # notify password
    echo "----------"
    echo "admin password: "$password
}


function enable_sso()
{
    echo enalbe_sso
    local hubdir="$1"
    local idp_proxy_host="$2"
    local entity_id="$3"
    local auth_proxy_metadata_url="$4"

    # check parameters
    if [ -z "$hubdir" ] || [ -z "$idp_proxy_host" ] || [ -z "$entity_id" ] || [ -z "$auth_proxy_metadata_url" ] ; then
        reportfailed "too few arguments."
    fi

    # check ssh private key
    [ ! -e "$SSH_IDP_PROXY_KEY" ] || reportfailed "idp-proxy ssh key '$ssh_key' does not exist."

    # set idp-proxy metadata in auth-proxy
    "$hubdir"/jhvmdir-hub/ssh-shortcut.sh -q sudo docker exec -i ${AUTH_PROXY_NAME} bash << EOF
/var/www/simplesamlphp/bin/get_idp_proxy_metadata.sh $idp_proxy_host
EOF

    # register auth-proxy metadat in idp-proxy 
    ssh -i $SSH_IDP_PROXY_KEY -o "StrictHostKeyChecking=no" -o "UserKnownHostsFile=/dev/null" idpproxy@${idp_proxy_host} -q sudo docker exec -i idp-proxy2 bash << EOF
/var/www/simplesamlphp/bin/add_auth_proxy_metadata.php $entity_id $auth_proxy_metadata_url
EOF
}

function disable_sso()
{
    echo disalbe_sso
    local hubdir="$1"
    local idp_proxy_host="$2"
    local entity_id="$3"

    # check parameters
    if [ -z "$hubdir" ] || [ -z "$idp_proxy_host" ] || [ -z "$entity_id" ] ; then
        reportfailed "too few arguments."
    fi

    # check ssh private key
    [ ! -e "$SSH_IDP_PROXY_KEY" ] || reportfailed "idp-proxy ssh key '$ssh_key' does not exist."
    
    # remove idp-proxy metadata in auth-proxy
    "$hubdir"/jhvmdir-hub/ssh-shortcut.sh -q sudo docker exec -i ${AUTH_PROXY_NAME} bash << EOF
/var/www/simplesamlphp/bin/remove_idp_proxy_metadata.sh $idp_proxy_host
EOF

    # remove auth-proxy metadat in idp-proxy 
    ssh -i $SSH_IDP_PROXY_KEY -o "StrictHostKeyChecking=no" -o "UserKnownHostsFile=/dev/null" idpproxy@${idp_proxy_host} -q sudo docker exec -i idp-proxy2 bash << EOF
/var/www/simplesamlphp/bin/remove_auth_proxy_metadata.php $entity_id
EOF
}

function reconfigure_one_jupyterhub()
{
    local hubdir="$1"
    local teacherid="$2"
    withslash=""

    "$hubdir"/jhvmdir-hub/ssh-shortcut.sh -q sudo docker exec -i root_jupyterhub_1 bash << EOF
    cat >/srv/jupyterhub_users/userlist << EOF3
$teacherid admin
EOF3

    cat >>/srv/jupyterhub_config/jupyterhub_config.py << EOF2
# change to unix authentication:
c.JupyterHub.authenticator_class = 'remote_user.remote_user_auth.RemoteUserLocalAuthenticator'

c.JupyterHub.base_url='$withslash/'

# next line is not used if docker_oauth.DockerAuthenticator is used
#c.GoogleOAuthenticator.oauth_callback_url = 'https://$urlbase${withslash}/hub/oauth2callback'
EOF2

EOF

    # At least once, the above failed for some reason.  Add a check to
    # make it clear if this happens again.
#    checklastline="$(
#      "$hubdir"/jhvmdir-hub/ssh-shortcut.sh -q \
#           sudo docker exec -i root_jupyterhub_1 \
#               tail -n 1 /srv/jupyterhub_config/jupyterhub_config.py
#    )"
#    if [[ "$checklastline" != */$urlbase${withslash}/* ]]; then
#	echo "Attempt to reconfigure a JupyterHub instance failed for some reason." 1>&2
#	echo "Please try running the command again." 1>&2
#	rm -f "$hubdir/hubid"
#	exit 1
#    fi
}


function delete_jupyterhub()
{
    local hubdir="$1"

    [ -d "$hubdir" ] || reportfailed "Hub directory '$hubdir' does not exist."

    while true; do
        read -p "Do you delete course '$hubdir'? [Y/n]" answer
        case $answer in
            '' | [Yy]* )
                rm -rf $hubdir
                break;
                ;;
            [Nn]* )
                break;
                ;;
            * )
              echo Please answer yes or no.
        esac
    done;
}


function restart_jupyterhub()
{
    local hubdir="$1"

    [ -d "$hubdir" ] || reportfailed "Hub directory '$hubdir' does not exist."

    "$hubdir"/jhvmdir-hub/ssh-shortcut.sh -q sudo docker stop root_jupyterhub_1
    "$hubdir"/jhvmdir-hub/ssh-shortcut.sh -q sudo docker start root_jupyterhub_1
}


function change_password()
{
    local hubdir="$1"
    local email="$2"
    local new_password="$3"

    if [ -z "$hubdir" ] || [ -z "$email" ] || [ -z "$new_password" ] ; then
        reportfailed "too few arguments."
    fi
    [ -d "$hubdir" ] || reportfailed "Hub directory '$hubdir' does not exist."

    "$hubdir"/jhvmdir-hub/ssh-shortcut.sh -q sudo docker exec -i ${AUTH_PROXY_NAME} bash << EOF
php /var/www/php/change-local-user-password.php $email $new_password
EOF
}


function reset_password()
{
    local hubdir="$1"
    local email="$2"

    if [ -z "$hubdir" ] || [ -z "$email" ] ; then
        reportfailed "too few arguments."
    fi
    [ -d "$hubdir" ] || reportfailed "Hub directory '$hubdir' does not exist."


    "$hubdir"/jhvmdir-hub/ssh-shortcut.sh -q sudo docker exec -i ${AUTH_PROXY_NAME} bash << EOF
php /var/www/php/reset-local-user-password.php $email
EOF
}


function dump_database()
{
    local hubdir="$1"
    for table in api_tokens users proxies hubs servers; do
	echo
	echo "Table: $table"
	"$hubdir"/jhvmdir-hub/ssh-shortcut.sh -q \
	    	 sudo docker exec -i root_jpydb_1 \
	    	 /usr/lib/postgresql/9.6/bin/psql -U postgres -d jupyterhub <<<"select * from $table ;"
    done
}


function fetch_hub_patch()
{
    # fetch the latest of whatever is already in hub-patch-dir-tree
    local hubdir="$1"
    hppath="$rootdir/hub-patch-dir-tree"

    filelist="$(cd "$hppath" && find -type f)"
    [ "$filelist" = "" ] && reportfailed "No files in hub-patch-dir-tree"

    "$hubdir"/jhvmdir-hub/ssh-shortcut.sh -qt sudo docker exec -i root_jupyterhub_1 bash <<EOF | ( cd "$rootdir/hub-patch-dir-tree" && tar xzv )
set -e
cd /
tar cz $(echo $filelist)
EOF
}


function push_hub_patch()
{
    local hubdir="$1"
    hppath="$rootdir/hub-patch-dir-tree"

    filelist="$(cd "$hppath" && ls)"

    (
	echo 'cd / || exit 0 ; tar xzv'
	cd "$rootdir/hub-patch-dir-tree" || exit
	# the tar on the prev line will start reading from stdin, which is provided by this tar:
	tar cz $filelist
    ) | "$hubdir"/jhvmdir-hub/ssh-shortcut.sh -q sudo docker exec -i root_jupyterhub_1 bash
}


function create_directory_structure()
{
    local hubdir="$1"
    local teacherid="$2"
    local auth_proxy_ssh_private_key="$3"

    "$hubdir"/jhvmdir-hub/ssh-shortcut.sh -q sudo bash <<EOF
       mkdir -p /jupyter/admin/{textbook,admin_tools,tools,info}
       chmod a+wr /jupyter/admin/{textbook,admin_tools,tools,info}

       mkdir -p /jupyter/users
       chmod a+wr /jupyter/users

       if getent passwd $teacherid > /dev/null ; then
	   echo "User ($teacherid) exists on hub KVM"
       else
	   echo "Creating user ($teacherid)"
	   # the next line does not create the home directory
	   useradd -s /bin/bash "$teacherid"
       fi

       mkdir -p "/jupyter/admin/$teacherid"
       mkdir -p "/jupyter/admin/$teacherid/.ssh"

       ipycfg="/jupyter/admin/$teacherid/.ipython/profile_default/ipython_config.py"
       mkdir -p "\${ipycfg%/*}"
       echo "c.InteractiveShellApp.matplotlib = 'inline'" >>"\$ipycfg"

       # Note: probably because of NFS, sometimes programs think this
       # this next symbolic link is a directory when normally it would
       # be behave as the link itself.
       [ -L "/jupyter/admin/$teacherid/admin_tools" ] || \
            ln -s /jupyter/admin/admin_tools "/jupyter/admin/$teacherid/admin_tools"
       chown -R "$teacherid:$teacherid" "/jupyter/admin/$teacherid"
       chmod -R a+wr "/jupyter/admin/$teacherid"
EOF
    # update with latest version
    tar c adapt-notebooks-for-user.sh background-command-processor.sh | \
	"$hubdir/jhvmdir-hub/ssh-shortcut.sh" -q sudo tar xv -C /srv

    # TODO: redo this
    "$hubdir"/jhvmdir-hub/ssh-shortcut.sh -q sudo bash <<EOF
killall background-command-processor.sh
cd /srv
bash -c 'setsid ./background-command-processor.sh 1>>bcp.log 2>&1 </dev/null &'
EOF
}

#----- main -----
cmd="$1"
shift

case "$cmd" in
    new) init_jupyterhub "$@"
        ;;
    enable-sso) enable_sso "$@"
        ;;
    disable-sso) disable_sso "$@"
        ;;
    delete) delete_jupyterhub "$@"
        ;;
    restart) restart_jupyterhub "$@"
        ;;
    change-password) change_password "$@"
        ;;
    reset-password) reset_password "$@"
        ;;
    debugjhub) reconfigure_one_jupyterhub "$@"
        ;;
    dumpdb) dump_database "$@"
        ;;
    fetch-hub-patch) fetch_hub_patch "$@"
        ;;
    push-hub-patch) push_hub_patch "$@"
        ;;
    *) usage
        ;;
esac
